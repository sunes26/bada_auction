"""
기존 categories.ts 데이터를 SQLite DB로 마이그레이션
"""
import sqlite3
from pathlib import Path

# 프로젝트 루트
DB_PATH = Path(__file__).parent / "monitoring.db"

# categories.ts에서 복사한 데이터
categoryIdMapping = {
    "흰밥": "1", "흑미": "2", "잡곡": "3", "현미": "4", "렌틸콩현미": "5",
    "채소영양": "6", "버섯영양": "7", "스팸김치": "8", "참치마요": "9", "치킨마요": "10",
    "팥죽": "11", "야채죽": "12", "소고기죽": "13", "전복죽": "14", "햄": "15",
    "닭": "16", "일반참치": "17", "고추참치": "18", "꽁치": "19", "고등어": "20",
    "파인애플": "21", "황도": "22", "후르츠칵테일": "23", "스위트콘": "24", "카레": "25",
    "짜장": "26", "마파두부": "27", "곰탕류": "28", "미역국": "29", "육개장": "30",
    "청국장": "31", "추어탕": "32", "삼계탕": "33", "무국": "34", "황태국": "35",
    "갈비탕": "36", "순두부찌개": "37", "부대찌개": "38", "버섯류": "39", "옥수수류": "40",
    "라면": "41", "짜파게티": "42", "비빔면": "43", "칼국수": "44", "물냉면": "45",
    "비빔냉면": "46", "소바": "47", "우동": "48", "고기만두": "49", "김치만두": "50",
    "새우만두": "51", "빨간떡볶이": "52", "크림떡볶이": "53", "짜장떡볶이": "54", "허니치킨": "55",
    "양념치킨": "56", "핫도그": "57", "피자": "58", "감자튀김": "59", "돈까스": "60",
    "치즈볼": "61", "치즈스틱": "62", "동그랑땡": "63", "떡갈비": "64", "치킨너겟": "65",
    "김치주먹밥": "66", "참치주먹밥": "67", "간장주먹밥": "68", "통합": "69", "콜라색": "70",
    "사이다색": "71", "오렌지색": "72", "라임색": "73", "파인색": "74", "포도색": "75",
    "밀키스색": "76", "블루색": "77", "레몬색": "84",
    "토마토색": "86", "망고색": "88", "살구색": "90",
    "라떼": "93", "아메리카노": "94", "블랙": "95",
    "보리": "96", "녹차": "97", "유자": "98", "생수": "99", "식혜": "100",
    "수정과": "101", "올리브": "102", "참기름/들기름": "103", "기타": "104", "초코": "105",
    "딸기": "106", "커피": "107", "바나나": "108", "미숫가루": "109", "일반두유": "110",
    "검은콩": "111", "아몬드": "112", "샴푸": "113", "린스/트리트먼트": "114", "헤어케어": "115",
    "바디워시/바디로션": "116", "핸드워시/핸드크림": "117", "풋케어": "118", "롤화장지": "119", "키친타월": "120",
    "티슈": "121", "물티슈": "122", "생리대": "123", "남성": "124", "여성": "125",
    "치약": "126", "칫솔": "127", "가글": "128", "면도": "129", "세탁세제": "130",
    "섬유유연제": "131", "욕실세제": "132", "주방세제": "133", "탈취제": "134", "제습제": "135",
    "장향제": "136", "살충제": "137", "기저귀": "138", "분유": "139", "유산균": "140",
    "비타민": "141", "홍삼/인상": "142", "어린이/청소년": "143", "스킨케어": "144", "썬케어": "145",
    "클렌징": "146", "팩": "147", "향수": "148", "남성화장품": "149"
}

categoryStructure = {
    "간편식": {
        "밥류": {
            "즉석밥": ["흰밥", "흑미", "잡곡", "현미", "렌틸콩현미", "채소영양", "버섯영양"],
            "덮밥": ["스팸김치", "참치마요", "치킨마요"],
            "죽": ["팥죽", "야채죽", "소고기죽", "전복죽"]
        },
        "통조림": {
            "햄": ["햄", "닭"],
            "참치": ["일반참치", "고추참치", "꽁치", "고등어"],
            "과일": ["파인애플", "황도", "후르츠칵테일", "스위트콘"]
        },
        "카레/짜장/덮밥": {
            "카레": ["카레"],
            "짜장": ["짜장"],
            "마파두부": ["마파두부"]
        },
        "국/찌개": {
            "곰탕류": ["곰탕류"], "미역국": ["미역국"], "육개장": ["육개장"], "청국장": ["청국장"],
            "추어탕": ["추어탕"], "삼계탕": ["삼계탕"], "무국": ["무국"], "황태국": ["황태국"],
            "갈비탕": ["갈비탕"], "순두부찌개": ["순두부찌개"], "부대찌개": ["부대찌개"]
        },
        "수프": {
            "버섯류": ["버섯류"],
            "옥수수류": ["옥수수류"]
        },
        "면": {
            "라면": ["라면"], "짜파게티": ["짜파게티"], "비빔면": ["비빔면"], "칼국수": ["칼국수"],
            "물냉면": ["물냉면"], "비빔냉면": ["비빔냉면"], "소바": ["소바"], "우동": ["우동"]
        }
    },
    "냉동식": {
        "만두": {"고기만두": ["고기만두"], "김치만두": ["김치만두"], "새우만두": ["새우만두"]},
        "떡볶이": {"빨간떡볶이": ["빨간떡볶이"], "크림떡볶이": ["크림떡볶이"], "짜장떡볶이": ["짜장떡볶이"]},
        "치킨": {"허니치킨": ["허니치킨"], "양념치킨": ["양념치킨"]},
        "핫도그": {"핫도그": ["핫도그"]},
        "피자": {"피자": ["피자"]},
        "감자튀김": {"감자튀김": ["감자튀김"]},
        "돈까스": {"돈까스": ["돈까스"]},
        "치즈볼": {"치즈볼": ["치즈볼"]},
        "치즈스틱": {"치즈스틱": ["치즈스틱"]},
        "동그랑땡": {"동그랑땡": ["동그랑땡"]},
        "떡갈비": {"떡갈비": ["떡갈비"]},
        "치킨너겟": {"치킨너겟": ["치킨너겟"]},
        "주먹밥": {"김치주먹밥": ["김치주먹밥"], "참치주먹밥": ["참치주먹밥"], "간장주먹밥": ["간장주먹밥"], "통합": ["통합"]}
    },
    "음료": {
        "탄산음료": {
            "탄산": ["콜라색", "사이다색", "오렌지색", "라임색", "파인색", "포도색", "밀키스색"],
            "이온음료": ["블루색", "오렌지색", "라임색", "파인색", "포도색"]
        },
        "주스/아이스티": {
            "주스/아이스티": ["오렌지색", "레몬색", "라임색", "토마토색", "파인색", "망고색", "포도색", "살구색", "밀키스색"]
        },
        "커피": {"라떼": ["라떼"], "아메리카노": ["아메리카노"], "블랙": ["블랙"]},
        "차류": {"보리": ["보리"], "녹차": ["녹차"], "유자": ["유자"]},
        "생수": {"생수": ["생수"]},
        "전통음료": {"식혜": ["식혜"], "수정과": ["수정과"]}
    },
    "식용유/오일": {
        "올리브": {"올리브": ["올리브"]},
        "참기름/들기름": {"참기름/들기름": ["참기름/들기름"]},
        "기타": {"기타": ["기타"]}
    },
    "우유/두유": {
        "우유": {"초코": ["초코"], "딸기": ["딸기"], "커피": ["커피"], "바나나": ["바나나"], "미숫가루": ["미숫가루"]},
        "두유": {"일반두유": ["일반두유"], "검은콩": ["검은콩"], "아몬드": ["아몬드"]}
    },
    "헤어/바디": {
        "샴푸": {"샴푸": ["샴푸"]},
        "린스/트리트먼트": {"린스/트리트먼트": ["린스/트리트먼트"]},
        "헤어케어": {"헤어케어": ["헤어케어"]},
        "바디워시/바디로션": {"바디워시/바디로션": ["바디워시/바디로션"]},
        "핸드워시/핸드크림": {"핸드워시/핸드크림": ["핸드워시/핸드크림"]},
        "풋케어": {"풋케어": ["풋케어"]}
    },
    "화장지,여성용품": {
        "롤화장지": {"롤화장지": ["롤화장지"]},
        "키친타월": {"키친타월": ["키친타월"]},
        "티슈": {"티슈": ["티슈"]},
        "물티슈": {"물티슈": ["물티슈"]},
        "생리대": {"생리대": ["생리대"]},
        "성인기저귀": {"남성": ["남성"], "여성": ["여성"]}
    },
    "구강/면도": {
        "치약": {"치약": ["치약"]},
        "칫솔": {"칫솔": ["칫솔"]},
        "가글": {"가글": ["가글"]},
        "면도": {"면도": ["면도"]}
    },
    "세제/세정제": {
        "세탁세제": {"세탁세제": ["세탁세제"]},
        "섬유유연제": {"섬유유연제": ["섬유유연제"]},
        "욕실세제": {"욕실세제": ["욕실세제"]},
        "주방세제": {"주방세제": ["주방세제"]},
        "탈취제": {"탈취제": ["탈취제"]},
        "제습제": {"제습제": ["제습제"]},
        "장향제": {"장향제": ["장향제"]},
        "살충제": {"살충제": ["살충제"]}
    },
    "유아동": {
        "기저귀": {"기저귀": ["기저귀"]},
        "분유": {"분유": ["분유"]}
    },
    "건강식품": {
        "유산균": {"유산균": ["유산균"]},
        "비타민": {"비타민": ["비타민"]},
        "홍삼/인상": {"홍삼/인상": ["홍삼/인상"]},
        "어린이/청소년": {"어린이/청소년": ["어린이/청소년"]}
    },
    "뷰티": {
        "스킨케어": {"스킨케어": ["스킨케어"]},
        "썬케어": {"썬케어": ["썬케어"]},
        "클렌징": {"클렌징": ["클렌징"]},
        "팩": {"팩": ["팩"]},
        "향수": {"향수": ["향수"]},
        "남성화장품": {"남성화장품": ["남성화장품"]}
    }
}

def migrate_categories():
    """카테고리 데이터를 DB로 마이그레이션"""
    conn = sqlite3.connect(str(DB_PATH))
    cursor = conn.cursor()
    
    # 테이블 생성 (schema.sql 실행)
    print("[INFO] categories 테이블 생성 중...")
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            folder_number INTEGER NOT NULL UNIQUE,
            folder_name TEXT NOT NULL,
            level1 TEXT NOT NULL,
            level2 TEXT NOT NULL,
            level3 TEXT NOT NULL,
            level4 TEXT NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    """)
    
    # 기존 데이터 삭제
    cursor.execute("DELETE FROM categories")
    
    # 카테고리 구조를 순회하며 DB에 삽입
    inserted_count = 0
    inserted_numbers = set()  # 이미 삽입된 폴더 번호 추적

    for level1, level2_dict in categoryStructure.items():
        for level2, level3_dict in level2_dict.items():
            for level3, level4_list in level3_dict.items():
                for level4 in level4_list:
                    # 폴더 번호 찾기
                    folder_number = categoryIdMapping.get(level4)
                    if folder_number and int(folder_number) not in inserted_numbers:
                        folder_name = f"{folder_number}_{level4}"

                        cursor.execute("""
                            INSERT INTO categories (folder_number, folder_name, level1, level2, level3, level4)
                            VALUES (?, ?, ?, ?, ?, ?)
                        """, (int(folder_number), folder_name, level1, level2, level3, level4))

                        inserted_numbers.add(int(folder_number))
                        inserted_count += 1
                        print(f"[OK] {folder_name}: {level1} > {level2} > {level3} > {level4}")
                    elif folder_number and int(folder_number) in inserted_numbers:
                        print(f"[SKIP] {folder_number}_{level4}: 중복 (이미 등록됨)")
    
    conn.commit()
    conn.close()
    
    print(f"\n[SUCCESS] {inserted_count}개 카테고리 마이그레이션 완료!")
    return inserted_count

if __name__ == "__main__":
    migrate_categories()
